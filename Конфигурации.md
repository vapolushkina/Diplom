### Terraform

```
....
....
....
....
....
```

---

### Ansible

`playbook`

```
---
- hosts: web
  become: true
  become_method: sudo
  become_user: root
  remote_user: admin
  roles:
   - role: nginx
   - role: node-exporter

- hosts: prom
  user: admin
  become: true
  become_method: sudo
  become_user: root
  roles:
    - role: prometheus

- hosts: grafana
  user: admin
  become: true
  become_method: sudo
  become_user: root
  roles:
    - role: grafana

- hosts: elastic
  user: admin
  become: true
  become_method: sudo
  become_user: root
  roles:
    - role: elastic

- hosts: kibana
  user: admin
  become: true
  become_method: sudo
  become_user: root
  roles:
    - role: kibana

- hosts: web
  become: true
  become_method: sudo
  become_user: root
  remote_user: admin
  roles:
   - role: filebeat

```

`nginx`

*1. tasks*

```
- name: ensure nginx is at the latest version
  apt: name=nginx state=latest
  become: yes

- name: start nginx
  service:
     name: nginx
     state: started
  become: yes

- name: replace nginx.conf
  template:
     src=templates/nginx.conf
     dest=/etc/nginx/nginx.conf

- name: replace default
  template:
     src=templates/default
     dest=/etc/nginx/sites-enabled/default

- name: copy the content of the web site
  copy:
    src: /etc/ansible/roles/nginx/static/
    dest: /var/www/html

- name: restart nginx
  service:
     name: nginx
     state: restarted
  become: yes
```
*2. vars*

```
---
# vars file for roles/nginx
worker_processes: auto
worker_connections: 2048
client_max_body_size: 512M
```
*3. static*

```
<html>
  <head>
<meta charset="UTF-8">
<center><h1>Всего хорошего!</h1><center>
<img src="https://github.com/vapolushkina/vapolushkina/assets/121248099/5b6845f>
  </head>
  </html>
```

`node-exporter`

*1. tasks*

```
---
# tasks file for roles/node-exporter

- name: check if node exporter exist
  stat:
    path: "{{ node_exporter_bin }}"
  register: __check_node_exporter_present

- name: create node exporter user
  user:
    name: "{{ node_exporter_user }}"
    append: true
    shell: /usr/sbin/nologin
    system: true
    create_home: false

- name: create node exporter config dir
  file:
    path: "{{ node_exporter_dir_conf }}"
    state: directory
    owner: "{{ node_exporter_user }}"
    group: "{{ node_exporter_group }}"

- name: if node exporter exist get version
  shell: "cat /etc/systemd/system/node_exporter.service | grep Version | sed s/'.*Version '//g"
  when: __check_node_exporter_present.stat.exists == true
  changed_when: false
  register: __get_node_exporter_version

- name: download and unzip node exporter if not exist
  unarchive:
    src: "https://github.com/prometheus/node_exporter/releases/download/v{{ node_exporter_version }}/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz"
    dest: /tmp/
    remote_src: yes
    validate_certs: no

- name: move the binary to the final destination
  copy:
    src: "/tmp/node_exporter-{{ node_exporter_version }}.linux-amd64/node_exporter"
    dest: "{{ node_exporter_bin }}"
    owner: "{{ node_exporter_user }}"
    group: "{{ node_exporter_group }}"
    mode: 0755
    remote_src: yes
  when: __check_node_exporter_present.stat.exists == false or not __get_node_exporter_version.stdout == node_exporter_version

- name: clean
  file:
    path: /tmp/node_exporter-{{ node_exporter_version }}.linux-amd64/
    state: absent

- name: install service
  template:
    src: node.j2
    dest: /etc/systemd/system/node_exporter.service
    owner: root
    group: root
    mode: 0755

- name: service always started
  systemd:
    name: node_exporter
    state: started
    enabled: yes
```
*2. vars*

```
---
# vars file for roles/node-exporter

node_exporter_version: "1.6.1"
node_exporter_bin: /usr/local/bin/node_exporter
node_exporter_user: expo
node_exporter_group: "{{ node_exporter_user }}"
node_exporter_dir_conf: /etc/node_exporter

nginx_log_exporter : 1.9.2
```
*3. templates*

```
[Unit]
Description=Node Exporter Version {{ node_exporter_version }}
After=network-online.target
[Service]
User={{ node_exporter_user }}
Group={{ node_exporter_user }}
Type=simple
ExecStart={{ node_exporter_bin }}
[Install]
WantedBy=multi-user.target
```

`prometheus`

*1. tasks*

```
....
....
....
....
....
```
*2. vars*

```
....
....
....
....
....
```
*3. static*

```
....
....
....
....
....
```

`grafana`

*1. tasks*

```
....
....
....
....
....
```
*2. vars*

```
....
....
....
....
....
```
*3. static*

```
....
....
....
....
....
```

`elasticsearch`

*1. tasks*

```
....
....
....
....
....
```
*2. vars*

```
....
....
....
....
....
```
*3. static*

```
....
....
....
....
....
```

`filebeat`

*1. tasks*

```
....
....
....
....
....
```
*2. vars*

```
....
....
....
....
....
```
*3. static*

```
....
....
....
....
....
```

`kibana`

*1. tasks*

```
....
....
....
....
....
```
*2. vars*

```
....
....
....
....
....
```
*3. static*

```
....
....
....
....
....
```
